var __awaiter=this&&this.__awaiter||function(i,a,s,l){return new(s||(s=Promise))(function(e,t){function r(e){try{o(l.next(e))}catch(e){t(e)}}function n(e){try{o(l.throw(e))}catch(e){t(e)}}function o(t){t.done?e(t.value):new s(function(e){e(t.value)}).then(r,n)}o((l=l.apply(i,a||[])).next())})},__generator=this&&this.__generator||function(r,n){var o,i,a,e,s={label:0,sent:function(){if(1&a[0])throw a[1];return a[1]},trys:[],ops:[]};return e={next:t(0),throw:t(1),return:t(2)},"function"==typeof Symbol&&(e[Symbol.iterator]=function(){return this}),e;function t(t){return function(e){return function(t){if(o)throw new TypeError("Generator is already executing.");for(;s;)try{if(o=1,i&&(a=2&t[0]?i.return:t[0]?i.throw||((a=i.return)&&a.call(i),0):i.next)&&!(a=a.call(i,t[1])).done)return a;switch(i=0,a&&(t=[2&t[0],a.value]),t[0]){case 0:case 1:a=t;break;case 4:return s.label++,{value:t[1],done:!1};case 5:s.label++,i=t[1],t=[0];continue;case 7:t=s.ops.pop(),s.trys.pop();continue;default:if(!(a=0<(a=s.trys).length&&a[a.length-1])&&(6===t[0]||2===t[0])){s=0;continue}if(3===t[0]&&(!a||t[1]>a[0]&&t[1]<a[3])){s.label=t[1];break}if(6===t[0]&&s.label<a[1]){s.label=a[1],a=t;break}if(a&&s.label<a[2]){s.label=a[2],s.ops.push(t);break}a[2]&&s.ops.pop(),s.trys.pop();continue}t=n.call(r,s)}catch(e){t=[6,e],i=0}finally{o=a=0}if(5&t[0])throw t[1];return{value:t[0]?t[1]:void 0,done:!0}}([t,e])}}};!function(e){if("object"==typeof module&&"object"==typeof module.exports){var t=e(require,exports);void 0!==t&&(module.exports=t)}else"function"==typeof define&&define.amd&&define(["require","exports","./Utils/Constants","./Utils/ExtractUtils","./Utils/LoggingUtils","./Utils/ValidateUtils","./Utils/TimerUtils","../lib/api.js"],e)}(function(e,t){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var U=e("./Utils/Constants");t.Constants=U.Constants;var r=e("./Utils/ExtractUtils");t.ExtractUtils=r.ExtractUtils;var k=e("./Utils/LoggingUtils");t.LoggingUtils=k.LoggingUtils;var M=e("./Utils/ValidateUtils");t.ValidateUtils=M.ValidateUtils;var w=e("./Utils/TimerUtils"),l=e("../lib/api.js");l.addNamespaceMapping("Office.Identity.WebAuth.BrowserAuth","5c65bbc4edbf480d9637ace04d62bd98-12844893-8ab9-4dde-b850-5612cb12e0f2-7822"),function(e){var u,h;function o(e,t){var r=w.TimerUtils.timer();(h=e).enableConsoleLogging&&(k.LoggingUtils.enableConsoleLogging=h.enableConsoleLogging),h.enableUpnCheck&&(M.ValidateUtils.enableUpnCheck=h.enableUpnCheck),h.authority&&(h.authority=h.authority.replace(U.Constants.Authority.ProdLegacy,U.Constants.Authority.Prod)),u||window.addEventListener("message",function(e){if(e.origin&&e.origin==location.origin&&e.data&&e.data.iframe&&e.data.request&&e.data.request==U.Constants.PostMessageType.RequestAuthConfig){var t=U.Constants.PostMessageType.iFramePrefix+e.data.iframe;if(null===(r=document.getElementById(t.replace("+"," ")))){t=U.Constants.PostMessageType.iFrameIdTokenPrefix;var r=document.getElementById(t.replace("+"," "))}if(k.LoggingUtils.log("received from "+t),null===r)return void k.LoggingUtils.log("targetiFrame is null");var n=r.contentWindow;null!=n&&(k.LoggingUtils.log("returning to "+e.data.iframe),n.postMessage({request:U.Constants.PostMessageType.ResponseAuthConfig,config:h},location.origin))}},!1);var n,o=h.idp.toLowerCase()===U.Constants.IdentityProvider.Msa.toLowerCase();o?h.authority=U.Constants.Authority.Prod+U.Constants.Authority.MsaSuffix:(h.authority||(h.authority=U.Constants.Authority.Prod+U.Constants.Authority.AadSuffix),h.authority.indexOf(U.Constants.Authority.AadSuffix)<0&&("/"==h.authority.charAt(h.authority.length-1)?h.authority+=U.Constants.Authority.AadSuffix:h.authority+="/"+U.Constants.Authority.AadSuffix)),u=new Array;for(var i=0,a=h.appIds;i<a.length;i++){var s=a[i];if(k.LoggingUtils.log("["+h.idp+"] Load->init: "+s),s&&M.ValidateUtils.isGuid(s)){var l={applicationId:s,application:new Msal.PublicClientApplication({auth:{clientId:s,authority:h.authority,redirectUri:h.redirectUri?h.redirectUri.split("?")[0]:location.href.split("?")[0],navigateToLoginRequestUrl:!h.navigateToLoginRequestUrl||h.navigateToLoginRequestUrl},cache:{cacheLocation:"localStorage",storeAuthStateInCookie:!1},system:{loadFrameTimeout:h.timeout?h.timeout:6e3}})};u.push(l),n||(n=s)}}return n?(k.LoggingUtils.log("["+h.idp+"] ssoSilent@Load->init"),y(n,h.upn,o?U.Constants.Authority.MsaSuffix:U.Constants.Authority.AadSuffix,t).then(function(e){return k.LoggingUtils.log("["+h.idp+"] ssoSilent@Load->success: "+e.idTokenClaims.aud),c(!0,t,u,r)}).catch(function(e){return k.LoggingUtils.log("["+h.idp+"] ssoSilent@Load->error: ["+e.errorCode+"]"+e.errorMessage),c(!0,t,u,r,e.errorCode,e.errorMessage)})):Promise.reject(c(!1,t,u,r))}function i(e,o,i,t,r,a,n){var s=this;void 0===a&&(a=!1);var l=w.TimerUtils.timer(),u=t||r,c=!1,d=T(o),g={},p=h.idp.toLowerCase()===U.Constants.IdentityProvider.Msa.toLowerCase();if(i&&M.ValidateUtils.isGuid(i)||(i=void 0),!e)return g.ErrorCode="missing_target",g.ErrorMessage="The provided target for BrowserAuth.GetToken is null, blank or empty",Promise.reject(v(g,i,o,a,l,void 0));var f=[M.ValidateUtils.getScope(e)];if(!o||!M.ValidateUtils.isGuid(o))return g.ErrorCode="invalid_application_ID",g.ErrorMessage="The provided application ID for BrowserAuth.GetToken is null, blank, empty or with invalid format",Promise.reject(v(g,i,o,a,l,f));var m=function(n){return new Promise(function(t,r){return __awaiter(s,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return k.LoggingUtils.log("["+o+"] acquireToken->init: popup:["+u+"]"),g={},[4,(u?d.acquireTokenPopup(n):d.acquireTokenSilent(n)).then(function(e){return(g.MsalResult=e).accessToken?M.ValidateUtils.upnMatchesUpnFromIdToken(e.idToken,h)&&(a||p||M.ValidateUtils.upnMatchesUpnFromAccessToken(e.accessToken,h))?(g.Token=e.accessToken,k.LoggingUtils.log("["+o+"] acquireToken->token: "+g.Token),t(g)):(g.ErrorCode="upn_mismatch",g.ErrorMessage="upn doesn't match with given upn in config",k.LoggingUtils.log("["+o+"] acquireToken->error: ["+g.ErrorCode+"]"+g.ErrorMessage),r(g)):(g.ErrorCode="no_tokens_found",g.ErrorMessage="Access token doesn't exist in auth response",k.LoggingUtils.log("["+o+"] acquireToken->error: ["+g.ErrorCode+"]"+g.ErrorMessage),r(g))}).catch(function(e){if(g.MsalResult=e,g.ErrorCode=e.errorCode,g.ErrorMessage=e.errorMessage,k.LoggingUtils.log("["+o+"] acquireToken->error: ["+g.ErrorCode+"]"+g.ErrorMessage),u||!c)return r(g);u=!0,k.LoggingUtils.log("["+o+"] acquireToken->retry: popup:["+u+"]"),m(n).then(function(e){return t(e)}).catch(function(e){return r(e)})})];case 1:return e.sent(),[2]}})})})};k.LoggingUtils.log("Config: "+JSON.stringify(d));var C={scopes:f,account:{username:h.upn},loginHint:h.upn,extraQueryParameters:{domain_hint:p?U.Constants.Authority.MsaSuffix:U.Constants.Authority.AadSuffix},correlationId:i,claims:n};return m(C).catch(function(t){return __awaiter(s,void 0,void 0,function(){var r,n=this;return __generator(this,function(e){switch(e.label){case 0:return r=!1,"no_tokens_found"!==t.ErrorCode?[3,2]:(k.LoggingUtils.log("["+o+"] ssoSilent@GetToken->init"),[4,y(o,h.upn,p?U.Constants.Authority.MsaSuffix:U.Constants.Authority.AadSuffix,i).then(function(){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return k.LoggingUtils.log("["+o+"] ssoSilent@GetToken->success"),[4,m(C).then(function(e){r=!0,g=e}).catch(function(e){g=e})];case 1:return e.sent(),[2]}})})}).catch(function(t){return __awaiter(n,void 0,void 0,function(){return __generator(this,function(e){switch(e.label){case 0:return g.ErrorCode=t.errorCode,g.ErrorMessage=t.errorMessage,k.LoggingUtils.log("["+o+"] ssoSilent@GetToken->error: ["+g.ErrorCode+"]"+g.ErrorMessage),"login_required"===t.errorCode&&(t.errorMessage.startsWith("AADSTS50058")||t.errorMessage.startsWith("Silent authentication was denied"))&&h.autoPopup?(c=!0,[4,m(C).then(function(e){r=!0,g=e}).catch(function(e){k.LoggingUtils.log("["+o+"] acquireToken@GetToken->error"),g=e})]):[3,2];case 1:e.sent(),e.label=2;case 2:return[2]}})})})]);case 1:e.sent(),e.label=2;case 2:return k.LoggingUtils.log("["+o+"] GetToken->isSuccess["+r+"]"),g=v(g,i,o,a,l,f),[2,r?Promise.resolve(g):Promise.reject(g)]}})})}).then(function(e){return k.LoggingUtils.log("["+o+"] GetToken->success"),Promise.resolve(v(e,i,o,a,l,f))})}function y(e,t,r,n){return T(e).ssoSilent({loginHint:t,extraQueryParameters:{domain_hint:r},correlationId:n})}function T(t){var r;if(u&&u.some(function(e){return!(!t||!e.applicationId||t.toUpperCase()!==e.applicationId.toUpperCase())&&(r=e.application,!0)}),!r){r=new Msal.PublicClientApplication({auth:{clientId:t,authority:h.authority,redirectUri:h.redirectUri?h.redirectUri.split("?")[0]:location.href.split("?")[0],navigateToLoginRequestUrl:!h.navigateToLoginRequestUrl||h.navigateToLoginRequestUrl},cache:{cacheLocation:"localStorage",storeAuthStateInCookie:!1},system:{loadFrameTimeout:h.timeout?h.timeout:6e3}});var e={applicationId:t,application:r};u.push(e)}return r}function c(e,t,r,n,o,i){if(!h.telemetryInstance&&"undefined"==typeof OTel){var a=[{name:U.Constants.Telemetry.Duration,int64:n.ms},{name:U.Constants.Telemetry.Succeeded,bool:!0},{name:U.Constants.Telemetry.IdentityProvider,string:h.idp.toLowerCase()},{name:U.Constants.Telemetry.CorrelationId,string:t||"unknown"},{name:U.Constants.Telemetry.LoadedApplicationCount,int64:r.length},{name:U.Constants.Telemetry.ErrorCode,string:o||"unknown"},{name:U.Constants.Telemetry.ErrorMessage,string:i||"unknown"}];l.sendTelemetryEvent({name:U.Constants.Telemetry.LoadTelemetryName,dataFields:a})}return{Telemetry:{timeToLoad:n.ms,succeeded:e,idp:h.idp.toLowerCase(),correlationId:t||"",loadedApplicationCount:r.length,errorCode:o||void 0,errorMessage:i||void 0}}}function v(e,t,r,n,o,i){if(!h.telemetryInstance&&"undefined"==typeof OTel){var a=[{name:U.Constants.Telemetry.Duration,int64:o.ms},{name:U.Constants.Telemetry.Succeeded,string:!e.Token},{name:U.Constants.Telemetry.IdentityProvider,string:h.idp.toLowerCase()},{name:U.Constants.Telemetry.ApplicationId,string:r},{name:U.Constants.Telemetry.TokenScope,string:i&&!n?i.toString():"unknown"},{name:U.Constants.Telemetry.CorrelationId,string:t||"unknown"},{name:U.Constants.Telemetry.ErrorCode,string:e.ErrorCode?e.ErrorCode:"unknown"},{name:U.Constants.Telemetry.ErrorMessage,string:e.ErrorMessage&&!n?e.ErrorMessage:"unknown"},{name:U.Constants.Telemetry.ErrorCodeForGetToken,string:e.ErrorCode?e.ErrorCode:"unknown"},{name:U.Constants.Telemetry.ErrorMessageForGetToken,string:e.ErrorMessage&&!n?e.ErrorMessage:"unknown"}];l.sendTelemetryEvent({name:U.Constants.Telemetry.GetTokenTelemetryName,dataFields:a})}return e.Telemetry={timeToGetToken:o.ms,succeeded:!e.Token,idp:h.idp.toLowerCase(),applicationId:r,tokenScope:i&&!n?i.toString():void 0,correlationId:t,errorCode:e.ErrorCode?e.ErrorCode:void 0,errorMessage:e.ErrorMessage&&!n?e.ErrorMessage:void 0,errorCodeForGetToken:e.ErrorCode?e.ErrorCode:void 0,errorMessageForGetToken:e.ErrorMessage&&!n?e.ErrorMessage:void 0,fromCache:!!e.MsalResult&&!!e.MsalResult.fromCache,expiresOn:e.MsalResult&&e.MsalResult.expiresOn?e.MsalResult.expiresOn.getTime()/1e3:void 0},e}function d(e,t,r,n,o,i,a){var s=[{name:U.Constants.Telemetry.Duration,int64:n.ms},{name:U.Constants.Telemetry.Succeeded,bool:!i},{name:U.Constants.Telemetry.IdentityProvider,string:h.idp.toLowerCase()},{name:U.Constants.Telemetry.ApplicationId,string:r},{name:U.Constants.Telemetry.TokenScope,string:o?o.toString():"unknown"},{name:U.Constants.Telemetry.CorrelationId,string:t||"unknown"},{name:U.Constants.Telemetry.ErrorCode,string:i||"unknown"},{name:U.Constants.Telemetry.ErrorMessage,string:a||"unknown"},{name:U.Constants.Telemetry.ErrorCodeForCheckUpn,string:i||"unknown"},{name:U.Constants.Telemetry.ErrorMessageForCheckUpn,string:a||"unknown"}];h.telemetryInstance||"undefined"!=typeof OTel||l.sendTelemetryEvent({name:U.Constants.Telemetry.CheckUpnTelemetryName,dataFields:s}),e.Telemetry={timeToCheckUPN:n.ms,succeeded:!i,idp:h.idp.toLowerCase(),applicationId:r,tokenScope:o?o.toString():void 0,correlationId:t,errorCode:i,errorMessage:a,errorCodeForCheckUPN:i,errorMessageForCheckUPN:a}}e.Load=o,e.GetToken=i,e.GetTokenOnce=function(e,t,r,n){return void 0===r&&(r=!1),void 0===n&&(n=!1),o({idp:r?U.Constants.IdentityProvider.Msa.toLowerCase():U.Constants.IdentityProvider.Aad.toLowerCase(),appIds:[t],authority:n?U.Constants.Authority.Ppe:U.Constants.Authority.Prod,upn:"",autoPopup:!0,enableConsoleLogging:!0}),i(e,t,void 0,!0)},e.GetApplication=T,e.CheckUpnMatchIdToken=function(n,o){var i=w.TimerUtils.timer();o&&M.ValidateUtils.isGuid(o)||(o=void 0);var a={};if(!n||!M.ValidateUtils.isGuid(n))return a.ErrorCode="invalid_application_ID",a.ErrorMessage="The provided application ID for BrowserAuth.CheckUpnMatchIdToken is null, blank, empty or with invalid format",d(a,o,n,i,void 0,a.ErrorCode,a.ErrorMessage),Promise.reject(a);var s=T(n),l=[n];return new Promise(function(t,r){k.LoggingUtils.log("Config: "+JSON.stringify(s));var e=s.getAccountByUsername(h.upn);k.LoggingUtils.log("application calls acquireTokenSilent"),s.acquireTokenSilent({scopes:l,account:e,correlationId:o}).then(function(e){if(a.IsUpnMatch=M.ValidateUtils.upnMatchesUpnFromIdToken(e.idToken,h),a.IsUpnMatch)return d(a,o,n,i,l),t(a)}).catch(function(e){return a.ErrorCode=e.errorCode,a.ErrorMessage=e.errorMessage,k.LoggingUtils.log("acquireToken->error: "+a.ErrorMessage),a.IsUpnMatch=!1,d(a,o,n,i,l,e.errorCode,e.errorMessage),r(a)})})},e.GetAuthConfig=function(){return new Promise(function(t,e){M.ValidateUtils.hashHasState().then(function(e){window.addEventListener("message",function(e){e.origin&&e.origin==location.origin&&e.data&&e.data.config&&e.data.request&&e.data.request==U.Constants.PostMessageType.ResponseAuthConfig&&t(e.data.config)},!1),parent.postMessage({request:U.Constants.PostMessageType.RequestAuthConfig,iframe:e},location.origin)},function(){e({})})})},e.Logout=function(){u.forEach(function(e){k.LoggingUtils.log("application calls logout"),e.application.logout()}),u=new Array}}(t.BrowserAuth||(t.BrowserAuth={}))});